(function(a){a.widget("apex.apex_session_timeout",{options:{timeoutAction:null,timeoutMessage:null,timeoutURL:null,logoutURL:null,showWarning:null,showWarningMiliBefore:null,showWarningTitle:null,showWarningMessage:null,hideHistory:false,sessionIdleDuration:null,maskBrowser:null,ajaxIdentifier:null,keepSessionAlive:null,debug:true},_create:function(){var b=this;apex.debug("Session Timeout: _create (start)");apex.debug("...Options");if(b.options.debug){for(name in b.options){apex.debug("......"+name+': "'+b.options[name]+'"')}}b._createPrivateStorage();b._startTimers();if(b.options.keepSessionAlive){b._startIdleMonitor();b._startPingTimer()}apex.debug("Session Timeout: _create (end)")},_startPingTimer:function(){var b=this;apex.debug("Session Timeout: _startSessionPingTimer (start)");b._values.pingID=setTimeout(function(){b._handlePing()},b._values.pingFrequency);apex.debug("Session Timeout: _startSessionPingTimer (end)")},_startIdleMonitor:function(){var b=this;apex.debug("Session Timeout: _startIdleMonitor (start)");a.idleTimer(b._values.checkIdleFrequency);a(document).bind("idle.idleTimer",function(){apex.debug("Session Timeout: session inactive!")});a(document).bind("active.idleTimer",function(){apex.debug("Session Timeout: session active!)");b._pingSession()});apex.debug("Session Timeout: _startIdleMonitor (end)")},_createPrivateStorage:function(){var b=this;apex.debug("Session Timeout: _createPrivateStorage (start)");b._values={docTitle:document.title,titleBlinkIntervalID:null,titleBlinkInterval:8000,warningID:null,timeoutID:null,pingID:null,checkIdleFrequency:60000,pingFrequency:60000,isWarned:false,timeoutActionEnum:{ALERT:"ALERT",REDIRECT:"REDIRECT",LOGOUT:"LOGOUT"}};b._elements={$dialog:{}};apex.debug("Session Timeout: _createPrivateStorage (end)")},_startTimers:function(){var b=this;apex.debug("Session Timeout: startTimer (start)");if(b.options.showWarning){b._values.warningID=setTimeout(function(){b._warn()},b.options.sessionIdleDuration-b.options.showWarningMiliBefore);apex.debug("...initializing warning timeout("+b._values.warningID+")")}b._values.timeoutID=setTimeout(function(){b._handleExpiredSession()},b.options.sessionIdleDuration);apex.debug("...initializing idle timeout("+b._values.timeoutID+")");apex.debug("Session Timeout: startTimer (end)")},_stopTimers:function(){var b=this;apex.debug("Session Timeout: _stopTimers (start)");if(b.options.keepSessionAlive&&b._values.timeoutID&&b._values.timeoutID!==null){apex.debug("...clearng idle timeout("+b._values.timeoutID+")");clearTimeout(b._values.timeoutID);b._values.timeoutID=null}if(b.options.showWarning&&b._values.warningID&&b._values.warningID!==null){apex.debug("...clearng warning timeout("+b._values.warningID+")");clearTimeout(b._values.warningID);b._values.warningID=null}apex.debug("Session Timeout: _stopTimers (end)")},_handleExpiredSession:function(){var b=this;apex.debug("Session Timeout: _handleExpiredSession (start)");if(b.options.maskBrowser){b._showMask()}setTimeout(function(){b._expireAction()},100);apex.debug("Session Timeout: _handleExpiredSession (end)")},_expireAction:function(){var b=this;apex.debug("Session Timeout: _expireAction (start)");if(!a.isEmptyObject(b._elements.$dialog)){b._elements.$dialog.dialog("close")}if(b.options.timeoutAction===b._values.timeoutActionEnum.ALERT){alert(b.options.timeoutMessage);b._redirect(b.options.timeoutURL)}else{if(b.options.timeoutAction===b._values.timeoutActionEnum.REDIRECT){b._redirect(b.options.timeoutURL)}else{if(b.options.timeoutAction===b._values.timeoutActionEnum.LOGOUT){b._redirect(b.options.logoutURL)}}}apex.debug("Session Timeout: _expireAction (end)")},_warn:function(){var b=this;apex.debug("Session Timeout: _warn (start)");var c='<div class="session-timeout-container ui-widget">   <p>'+b.options.showWarningMessage+"</p></div>";a("body").append(c);b._elements.$dialog=a(".session-timeout-container");b._elements.$dialog.dialog({disabled:false,autoOpen:true,buttons:{Ok:function(){a(this).dialog("close")}},closeOnEscape:true,closeText:"Close",dialogClass:"session-timeout-dialog",draggable:true,height:"auto",hide:null,maxhHeight:false,maxWidth:false,minHeight:100,minWidth:200,modal:true,resizable:false,show:null,stack:true,title:b.options.showWarningTitle,close:function(){b._closeWarning()}});b._startTitleBlink();b._values.isWarned=true;if(b.options.keepSessionAlive){a.idleTimer("destroy")}apex.debug("Session Timeout: _warn (end)")},_closeWarning:function(){var b=this;apex.debug("Session Timeout: _closeWarning (start)");b._elements.$dialog.dialog("destroy");b._elements.$dialog.remove();b._stopBlink();b._stopTimers();b._values.isWarned=false;if(b.options.keepSessionAlive){b._pingSession();b._startIdleMonitor()}apex.debug("Session Timeout: _closeWarning (end)")},_startTitleBlink:function(){var b=this;apex.debug("Session Timeout: _startTitleBlink (start)");b._titleBlink();b._values.titleBlinkIntervalID=setInterval(function(){b._titleBlink()},b._values.titleBlinkInterval);apex.debug("Session Timeout: _startTitleBlink (end)")},_titleBlink:function(){var b=this;apex.debug("Session Timeout: _titleBlink (start)");document.title=b.options.showWarningTitle;setTimeout(function(){document.title=b._values.docTitle},500);apex.debug("Session Timeout: _titleBlink (end)")},_stopBlink:function(){var b=this;apex.debug("Session Timeout: _stopBlink (start)");document.title=b._values.docTitle;clearInterval(b._values.titleBlinkIntervalID);apex.debug("Session Timeout: _stopBlink (end)")},_redirect:function(b){var c=this;apex.debug("Session Timeout: _redirect (start)");if(c.options.hideHistory){window.location.replace(b)}else{window.location.href=b}apex.debug("Session Timeout: _redirect (end)")},_showMask:function(){var c=this;var b=a(document).height();var e=a(window).width();var d=a(document.createElement("div")).attr("id","session-timeout-mask").css({width:e,height:b});apex.debug("Session Timeout: _showMask (start)");apex.debug("...maskHeight:"+b);apex.debug("...maskWidth:"+e);a("body").append(d);a(window).resize(function(){var f=a(document).height();var g=a(window).width();a("#session-timeout-mask").css({width:g,height:f})});apex.debug("Session Timeout: _showMask (end)")},_handlePing:function(){var b=this;apex.debug("Session Timeout: _handlePing (start)");if(a.data(document,"idleTimer")==="active"){apex.debug("session is active. Refreshing server session");b._pingSession()}else{apex.debug("session is inactive. Do not refresh server session.")}apex.debug("Session Timeout: _handlePing (end)")},_pingSession:function(){var b=this;var c;apex.debug("Session Timeout: _pingSession (start)");c={p_flow_id:a("#pFlowId").val(),p_flow_step_id:a("#pFlowStepId").val(),p_instance:a("#pInstance").val(),p_request:"PLUGIN="+b.options.ajaxIdentifier};a.ajax({type:"POST",url:"wwv_flow.show",data:c,dateType:"text",async:true,success:function(d){apex.debug("Ajax request successful");clearTimeout(b._values.pingID);b._startPingTimer();b._stopTimers();b._startTimers()}});apex.debug("Session Timeout: _pingSession (end)")}})})(apex.jQuery);